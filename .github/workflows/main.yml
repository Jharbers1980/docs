name: Build DIST
on: push
jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      AWS_DEFAULT_REGION: eu-west-1
      AWS_EC2_METADATA_DISABLED: 1
    steps:
    - uses: actions/checkout@v2
    - name: Install
      run: |
       yarn install
    - name: Generate dist
      run: |
        yarn build
    - name: "Check dist dir consistency"
      uses: andstor/file-existence-action@v1
      with:
        files: "dist/docs/index.html"
        allow_failure: true # Makes the Action fail on missing files
    - name: Configure AWS credentials
      if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') }}
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_ACCESS_PASSWORD }}

    - name: Copy files to the https://merginmaps.com/docs
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      run: |
        aws s3 sync ./dist s3://main-merginmaps.docs --follow-symlinks --delete

    - name: Copy files to the https://dev.merginmaps.com/docs
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/dev' }}
      run: |
        aws s3 sync ./dist s3://dev-merginmaps.docs --follow-symlinks --delete

